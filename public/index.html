<!DOCTYPE HTML>
<html>
<head>
    <title>GeoHits</title>
	<link rel="shortcut icon" href="image/icon.png">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="Veja as músicas mais tocadas ao redor do mundo!" content="">
    <meta name="Rodolfo e Jonatas" content="">
    <link type="text/css" href="styles.css" rel="stylesheet" />
    <link href="sp-bootstrap.min.css" rel="stylesheet" media="screen">
	<script type="text/jsx" src="geohits.js"></script>
</head>

<body>

    <div class="navbar navbar-default navbar-fixed-top" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <a class="navbar-brand" href="index.html"><img src="image/icon.png"><span id="text" style="color:#46ED1C; font-size:50px; padding:10px;">GeoHits</span></a>
        </div>
      </div>
    </div>


<div id='top' class="hero-unit">
   <div class="container-fluid" id="jumbo-dialog">
		<h1 id='attitle'><img src="image/logo_transparente.png"GeoHits></h1>
		<!--<p class="lead">VIAJE PELO MUNDO DA SUA CASA</p>-->
        <p id='text'>Veja as músicas mais tocadas do país ou do mundo!</p>
		<div class='intro-form' id='login-form'>
            <p> Conecte-se com seu Spotify.
            </p>
			<p><a class="btn btn-primary btn-lg" id='login-button'
                        role="button">Começar</a></p>
		</div>			
        <div id="search-form" class="intro-form row">
			<div class="col-xs-offset-1 col-xs-10 col-sm-offset-3 col-sm-6">
            <input type="text" class="form-control input-lg" id="playlist-terms" placeholder="Escolha o país desejado" value="">
				<br>
                <button class="btn btn-primary btn-lg" id='go' role="button">Busca</button>
			</div>
		</div>
    </div>
</div>

<div class="container-fluid work">
	<div id='info' class="h1 text-center"></div>

	
		<div class="results" id='playlist-table'>
           <h1> Achando playlist para <span class='keywords'></span></h1>
		   
		   <div class="progress">
            <div id='playlist-progress' class="progress-bar" role="progressbar" aria-valuenow="60"
                aria-valuemin="0" aria-valuemax="100" style="width: 0%;">
                <span class="sr-only"></span>
              </div>
          </div>
	
	
	
			<!-- <button class='stop-button btn btn-primary'>  stop </button> -->
			<div class='button-row'>
              Nos encontramos
              <span class="total-playlists"> </span> playlists com um total de <span class='total-tracks'> 0 </span> músicas.
              <br>

            <div id='fetch-tracks-ready'>
              Aperte
              <b> TOP HITS </b> para montar uma playlist com as musicas mais populares ou volte e <a href="index.html">refine sua busca.</a>.
              <div class='obutton-row'>
                  <button id='fetch-tracks' class='btn btn-primary'>  TOP MÚSICAS</button>
              </div>
             </div>
          </div>
		  
		  <table class="table table-striped table-bordered">
            <thead>
                <tr> <th style="width:5%"> # </th>
                     <th style="width: 85%"> Playlist </th>
                     <th style="width:10%"> # Musica </th>
                </tr>
            </thead>
            <tbody id="playlist-items"> </tbody>
          </table>
		</div>

		  
	<div class="results" id='track-table'>	  
		<h1> <a id='playlist-name'>Top <span class='keywords'> </span></a></h1>
		<div class="button-row">
              <div id='fetching-tracks'>
				Juntando <span id='tt-total-tracks'> </span> musicas de todas as <span class= "keywords"></span> playlists.
                <p>
                Você pode interromper a qualquer momento, mas quanto mais esperar melhor o resultado.
                </p>
                  <button id='stop-button'
                    class='padded-button stop-button btn btn-primary'>
                    Pare </button>
              </div>
              <div id='ready-to-save'>
                  Top 100 <span class='keywords'></span>.
                  <br>
                  <!--<button id="save-button"
                    class="padded-button btn btn-primary btn-lg">
                        Salve a playlist no Spotify</button>-->
			  </div>
		</div>
		
		<div class="progress">
            <div id='track-progress' class="progress-bar" role="progressbar" aria-valuenow="60"
                aria-valuemin="0" aria-valuemax="100" style="width: 0%;">
                <span class="sr-only"></span>
              </div>
          </div>
		  <table class="table table-striped table-bordered">
            <thead>
                <tr> <th style="width:5%"> # </th>
                     <th style="width:40%"> Música </th>
                     <th style="width:35%"> Artista </th>
                     <th style="width:10%"> Popularidade</th> </tr>
            </thead>
            <tbody id="track-items"> </tbody>
          </table>
	</div>
</div>
	


	
<div id="footer">
  <div class="container">
  <small>
    <p class="muted credit">Criado para a disciplina de CPD <a href="http://www.inf.ufrgs.br/~oliveira/Cursos/INF01124/INF01124_descricao_2005_1.html">UFRGS</a>.
	</p>
    <p class="muted credit">Powered by <a href="http://spotify.com">Spotify</a></p>.
  </small>
  </div>
</div>

	<script src="lib/jquery-1.11.1.min.js"></script>
    <script src="lib/bootstrap.min.js"></script>
    <script src="lib/underscore-min.js"></script>

<script>
"use strict";

var maxPlaylists = 1000;
var maxPlaylistsToDisplay = 1000;
var credentials = null;

var totalTracks = 0;
var totalPlaylistCount = 0;

var abortFetching = false;
var popNormalize = false;

var allPlaylists = [];
var topTracks = null;
var allTracks = {};

function error(s) {
    info(s);
}

function info(s) {
    $("#info").text(s);
}

function callSpotify(url, data) {
    return $.ajax(url, {
        dataType: 'json',
        data: data,
        headers: {
            'Authorization': 'Bearer ' + credentials.token
        }
    });
}

function postSpotify(url, json, callback) {
    $.ajax(url, {
        type: "POST",
        data: JSON.stringify(json),
        dataType: 'json',
        headers: {
            'Authorization': 'Bearer ' + credentials.token,
            'Content-Type': 'application/json'
        },
        success: function(r) {
            callback(true, r);
        },
        error: function(r) {
            // 2XX status codes are good, but some have no
            // response data which triggers the error handler
            // convert it to goodness.
            if (r.status >= 200 && r.status < 300) {
                callback(true, r);
            } else {
                callback(false, r);
            }
        }
    });
}


function findMatchingPlaylists(text) {
    var outstanding = 0;

    function addItem(tbody, which, item) {
        var tr= $("<tr>");
        var rowNumber = $("<td>").text(which);
        var title = $("<td>").append($("<a>").attr('href', item.uri).text(item.name));
        var tracks = $("<td>").text(item.tracks.total);
        tr.append(rowNumber);
        tr.append(title);
        tr.append(tracks);
        $("#playlist-item").append(tr);
        tbody.append(tr);
    }

    function showSearchResults(data) {
        outstanding--;

        var matching = data.playlists.total > maxPlaylists ? ">" 
            + maxPlaylists : data.playlists.total;
        $("#matching").text(matching);
        var tbody = $("#playlist-items");
        _.each(data.playlists.items, function(item, which) {
            if (true || !item.collaborative) {
                if (allPlaylists.length < maxPlaylistsToDisplay) {
                    addItem(tbody, data.playlists.offset + which + 1, item);
                }
                if (allPlaylists.length < maxPlaylists)  {
                    allPlaylists.push( [item.owner.id, item.id]);
                    totalTracks += item.tracks.total;
                }
            } else {
            }
        });

        var totalPlaylists = allPlaylists.length;
        var total = Math.min(data.playlists.total, maxPlaylists);
        var percentComplete = Math.round(totalPlaylists * 100 / total);

        $(".total-tracks").text(totalTracks);
        $(".total-playlists").text(totalPlaylists);
        $("#playlist-progress").css('width', percentComplete + "%");

        if (abortFetching || outstanding == 0) {
            abortFetching = false;
            if (totalPlaylists > 0) {
                $('#fetch-tracks-ready').show(200);
            } else {
                info("No matching playlists found");
                $('#fetch-tracks-ready').show(200);
            }
        }
    }

    function processPlaylistError() {
        outstanding--;
        error("Can't get playlists");
    }

    function processPlaylists(data) {
        var total = Math.min(data.playlists.total, maxPlaylists);
        var offset = data.playlists.offset + data.playlists.items.length;
        for (var i = offset; i < total; i += 50) {
            var url = 'https://api.spotify.com/v1/search';
            var params = {
                q: text,
                type:'playlist',
                limit:data.playlists.limit,
                offset:i
            };
            outstanding++;
            callSpotify(url, params).then(showSearchResults, processPlaylistError);
        }
        showSearchResults(data);
    }

    totalTracks = 0;
    abortFetching = false;
    allPlaylists = [];
    $('#fetch-tracks-ready').hide();

    var url = 'https://api.spotify.com/v1/search';
    var params = {
        q: text,
        type:'playlist',
        limit:50
    };
    var offset = 0;
    $("#playlist-items").empty();
    outstanding++;
    callSpotify(url, params).then(processPlaylists, processPlaylistError);
}


function go() {
    $("#top").hide(200);
    var text = $("#playlist-terms").val()
    if (text.length > 0) {
        info("");
        $(".keywords").text(text);
        $(".results").hide();
        $("#playlist-table").show();
        findMatchingPlaylists(text);
    } else {
        info("Enter some keywords first");
    }
}

function new_getTrackScore(track) {
    if (popNormalize) {
        var factor = track.popularity  > 30 ? track.popularity : 30;
        factor = factor * factor;
        var score = 1000. * track.count / factor;
        return score;
    } else {
        return track.count;
    }
}

function getTrackScore(track) { 
    //return old_getTrackScore(track);
    return new_getTrackScore(track);
}

function refreshTrackList(allTracks) {
    info("");

    var tracks = [];
    _.each(allTracks, function(track, id) {
        track.score = getTrackScore(track);
        tracks.push(track);
    });
    tracks.sort(function(a,b) {
        return b.score - a.score;
    });

    topTracks = tracks.slice(0, 100);
    var table = $("#track-items");
    var newRows = [];
    _.each(topTracks, function(track, i) {
        var tr = $("<tr>");
        tr.append( $("<td>").text(i + 1));
        tr.append( $("<td>").append( $("<a>").attr('href', track.uri).text(track.name)));
        tr.append( $("<td>").text(track.artists[0].name));
        tr.append( $("<td>").text(Math.round(track.score)));
        newRows.push(tr);
    });
    table.empty().append(newRows);
}

function saveTidsToPlaylist(playlist, tids) {
    var url = "https://api.spotify.com/v1/users/" + playlist.owner.id +
         "/playlists/" + playlist.id + '/tracks';

    postSpotify(url, {uris: tids}, function(ok, data) {
        if (ok) {
            info("Playlist saved");
            $("#ready-to-save").hide(100);
            $("#playlist-name").attr('href', playlist.uri);
        } else {
            error("Trouble saving to the playlist");
        }
    });
}

function savePlaylist() {
    var title = getPlaylistTitle();
    var tids = [];

    _.each(topTracks, function(track, i) {
        tids.push(track.uri);
    });

    var url = "https://api.spotify.com/v1/users/" + credentials.user_id + "/playlists";
    var json = { name: title};

    postSpotify(url, json, function(ok, playlist) {
        if (ok) {
            saveTidsToPlaylist(playlist, tids);
        } else {
            error("Can't create the new playlist");
        }
    });
}

function getPlaylistTitle() {
    return "Top " + $("#playlist-terms").val() + " tracks";
}


function fetchAllTracksFromPlaylist() {
    var start = new Date().getTime();
    $(".results").hide();
    $("#track-table").show();
    $("#ready-to-save").hide();
    $("#fetching-tracks").show();

    allTracks = {};

    var queue = allPlaylists.slice(0);
    var totalTracks = 0;
    totalPlaylistCount = 0;

    function isGoodPlaylist(items) {
        // good playlist needs multiple artists and
        // multiple albums
        var albums = {};
        var artists = {};

        _.each(items, function(item) {
            if (item.track) {
                var track = item.track;
                var rid = track.album.id;
                var aid = track.artists[0].id;
                albums[rid] = rid;
                artists[aid] = aid;
            }
        });
        return Object.keys(albums).length > 1 && Object.keys(artists).length > 1;
    }


    function doneFetching() {
        abortFetching = false;
        $("#fetching-tracks").hide(100);
        if (topTracks.length == 0) {
            info("No matching tracks found");
        } else {
            $("#ready-to-save").show();
        }
        var end = new Date().getTime();
        var total = end - start;
        console.log('delta time', total, 'len', 
            allPlaylists.length, 'per 1000', Math.round(total / allPlaylists.length));

    }

    var outstanding = 0;
    var maxSimultaneous = 10;

    function fetchNextTracksFromPlaylist() {
        while (!abortFetching && queue.length > 0 && outstanding < maxSimultaneous) {
            var tinfo = queue.pop(0);
            var user = tinfo[0];
            var pid = tinfo[1];

            var url = "https://api.spotify.com/v1/users/"
                + user + "/playlists/" + pid + "/tracks";
            outstanding++;
            callSpotify(url).then(
                function(data) {
                    var remaining = outstanding + queue.length;
                    var progress = Math.round(100.0 - (100.0 * remaining / allPlaylists.length));

                    $("#track-progress").css('width', progress + "%");
                    $("#tt-total-tracks").text(totalTracks);
                    $("#tt-unique-tracks").text(Object.keys(allTracks).length);
                    if (isGoodPlaylist(data.items)) {
                        totalPlaylistCount += 1;
                        _.each(data.items, function(item, i) {
                            var count = i == 0 ? 3 : i <= 2 ? 1 : 1;
                            if (item.track) {
                                if (item.track.id) {
                                    if ( !(item.track.id in allTracks) ) {
                                        allTracks[item.track.id] = item.track;
                                        allTracks[item.track.id].count = 0;
                                    }
                                    allTracks[item.track.id].count += count;
                                    totalTracks += 1;
                                }
                            }
                        });
                    } else {
                    }

                    refreshTrackList(allTracks);

                    --outstanding;
                    if (outstanding <= 0 && (abortFetching ||queue.length == 0)) {
                        doneFetching();
                    }  else {
                        fetchNextTracksFromPlaylist();
                    }
                },

                function() {
                    error("trouble fetching tracks");
                    --outstanding;
                    if (outstanding <= 0 && (abortFetching || queue.length == 0)) {
                        doneFetching();
                    }  else {
                        fetchNextTracksFromPlaylist();
                    }
                }
            );
        } 
    }
    fetchNextTracksFromPlaylist();
}


function initApp() {
    $(".intro-form").hide();
    $(".results").hide();
    $("#playlist-terms").keyup(
        function(event) {
            if (event.keyCode == 13) {
                go();
            }
        }
    );
    $("#go").on('click', function() {
        go();
    });

    $(".stop-button").on('click', function() {
        abortFetching = true;
    });

    $("#fetch-tracks").on('click', function() {
        fetchAllTracksFromPlaylist();
    });

    $("#login-button").on('click', function() {
        loginWithSpotify();
    });
    $("#save-button").on('click', function() {
        savePlaylist();
    });

    $("#norm-for-pop").on('click', function() {
        popNormalize = $("#norm-for-pop").is(':checked');
        refreshTrackList(allTracks);
    });
}


function loginWithSpotify() {
    var client_id = 'c9b0abc1be4c4302b22dbe7d2d74b376';
    var redirect_uri = 'http://localhost:8888/index.html';
    var scopes = 'playlist-modify-public';
//http://localhost:8888/index.html
    if (document.location.hostname == 'localhost') {
        redirect_uri = 'http://localhost:8888/index.html';
    }

    var url = 'https://accounts.spotify.com/authorize?client_id=' + client_id +
        '&response_type=token' +
        '&scope=' + encodeURIComponent(scopes) +
        '&redirect_uri=' + encodeURIComponent(redirect_uri);
    document.location = url;
}


function getTime() {
    return Math.round(new Date().getTime() / 1000);
}

function performAuthDance() {
    // if we already have a token and it hasn't expired, use it,
    if ('credentials' in localStorage) {
        credentials = JSON.parse(localStorage.credentials);
    }

    if (credentials && credentials.expires > getTime()) {
        $("#search-form").show();
    } else {
    // we have a token as a hash parameter in the url
    // so parse hash
        var hash = location.hash.replace(/#/g, '');
        var all = hash.split('&');
        var args = {};

        all.forEach(function(keyvalue) {
            var idx = keyvalue.indexOf('=');
            var key = keyvalue.substring(0, idx);
            var val = keyvalue.substring(idx + 1);
            args[key] = val;
        });

        if (typeof(args['access_token']) != 'undefined') {
            var g_access_token = args['access_token'];
            var expiresAt = getTime() + 3600;

            if (typeof(args['expires_in']) != 'undefined') {
                var expires = parseInt(args['expires_in']);
                expiresAt = expires + getTime();
            }

            credentials = {
                token:g_access_token,
                expires:expiresAt
            }

            callSpotify('https://api.spotify.com/v1/me').then(
                function(user) {
                    credentials.user_id = user.id;
                    localStorage['credentials'] = JSON.stringify(credentials);
                    location.hash = '';
                    $("#search-form").show();
                },
                function() {
                    error("Can't get user info");
                }
            );
        } else {
    // otherwise, got to spotify to get auth
            $("#login-form").show();
        }
    }
}


$(document).ready(
    function() {
        initApp();
        performAuthDance();
    }
);

</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-3675615-45', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
